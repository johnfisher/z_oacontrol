ZiPEC 0.3 - April 2011

Zenoss iPhone Events Console

©2008-2011 Willy Le Roy - Released under GPL License

ZiPEC webapp icon by Shannon Gernyi

English is not my first language, my apologies for all the mistakes. 

=== PURPOSE

This webapp allows mobile Zenoss users to have access to active alerts in a
Zenoss server (what's currently listed in the events console), through a light-
weight graphical user interface.


=== REQUIREMENTS

ZiPEC is coded in PHP, and therefore requires a php-capable webserver, with MySQL
functions installed. If installed on the same machine as Zenoss, ZiPEC can use the
same MySQL user as zenoss to access events database.


=== LIMITATIONS

Events can now be aknowledged (since 0.3 release), but still can't be cleared.
To keep things simple, I didn't implement authentication - so keep in mind this
service, as is, is not secured in any way and accessible to anyone. Authentication can
be implemented through Apache auth mechanisms, if you need it.

This project was initiated with PHP because it's the only language I can code in, but
I'd be more than happy if some python guru ports this webapp natively in Zenoss. I
would have done this myself if I could - but alas, I couldn't.

There's no fancy iPhone/Webkit specific vfx such as slides or glowing buttons. Those
are doable mostly in css and with a bit of javascript, but it would be a better idea to
use an existing framework such as WebApp.Net ( http://webapp.net.free.fr ).


=== FILES AND DIRECTORIES

index.php			The 'engine' that does all the work
portlet.php			Events list that allows you to display events in Zenoss' Dashboard
include/config.php		Configuration file, pretty self-explanatory
include/portlet_config.php	Configuration file for the portlet
include/layout.php		The HTML UI itself
include/functions.php		PHP functions ZiPEC requires
include/locale/en_US.php	English Language File
include/locale/fr_FR.php	French Language File
skins/				Directory where skins are stored
skins/default/			Default Skin Directory 
js/				Directory where javascript (AJAX,iscroll) files are stored
Files in skin directory:

 Files				| Size	| Description
-------------------------------------------------------------------------------------------------------------------------
./img/apple-touch-icon.png	57x57	ZiPEC's icon (the one that appears on home screen)
./img/zenoss.png		320x43	Logo
./img/overlay.png		320×43	32bit PNG that adds a glossy effect over your logo (can be disabled in iphone.css)
./img/bg.gif			7x1	Background Image (can be any size, tileable or not - edit iphone.css accordingly)
./img/toolbar_bg.png		1x44	Lower Toolbar background
./img/all.png			43x43	Button for "Display ALL events" - Unselected state
./img/all_selected.png		43x43	Button for "Display ALL events" - Selected state
./img/new.png			43x43	Button for "Display NEW events only" - Unselected state
./img/new_selected.png		43x43	Button for "Display NEW events only" - Selected state
./img/refresh.png		43x43	Button for "Refresh events list" - Unselected state
./img/refresh_on.png		43x43	Button for "Refresh events list" - Selected state
./img/setup.png			43x43	Button for "Setup utility" - Unselected state
./img/setup_on.png		43x43	Button for "Setup utility" - Selected state
./img/reload.gif		32x32	Animated GIF image displayed when the list is refreshing
./iphone.css			N/A	ZiPEC Cascading Style Sheet
./blackberry.css		N/A	CSS sent by ZiPEC to Blackberries

Note: the glossy effect over the webapp icon is automatically generated by the iPhone, so don't bother doing one when designing your own icon.


=== INSTALLATION on the Zenoss server

First, make sure your server has the following package installed :
	* Apache v1/v2 (the version doesn't matter)
	* PHP4 or PHP5, standalone or module for apache (No tests has been made on PHP4, but this should work)
	* MySQL module for PHP ( or PHP compiled with --with-mysql option )
You may need to adapt Apache configuration so it can run without conflict with Zenoss (TCP port should be different). 
No MySQL server is required, as Zenoss already has one running.

Untar the package in Apache's documents root ( /var/www/ in most distribs ), or in any directory you wish, as long as Apache has access to it.

Now edit the config file ( include/config.php ) so it can access your Zenoss events database. 
	// Zenoss Database Parameters
		"db_host" =>	"127.0.0.1:3307",	// Hostname/IP and TCP port of the Zenoss MySQL service
// In case you're connecting through a socket :
		"db_host" =>	":/usr/local/zenoss/mysql/tmp/mysql.sock",
	
		"db_base" =>	"events",		// Zenoss Events MySQL Database
		"db_tabl" =>	"status",		// Zenoss events MySQL table name
		"db_user" =>	"zenoss",		// Zenoss MySQL user
		"db_pass" =>	"zenoss",		// Zenoss MySQL password
Note that the default values should work on a vanilla zenoss system.
You can also change other values to your liking such as the event filter, contexts, etc.


=== INSTALLATION on an iPhone / iPod Touch

Launch Safari and type the URL that points to ZiPEC. Typically, this should be http://yourzenoss/zipec if you have performed a default installation. Once the UI is loaded, press the + button at the bottom of the screen and choose 'Add to home screen' from the menu. Safari should allow you to change the webapp name, and then it quits and installs ZiPEC on the home screen. From there, you no longer needs to launch Safari to access ZiPEC


=== CUSTOMIZING

Designing your own skin

In a shell, cd to the skins directory and make a copy of the default skin :
$ cp -r default your_skin_name

Then edit/replace the files to your liking (your company's logo, fonts, etc)

Edit include/config.php, and change the ui_skin value :
"ui_skin" =>	"your_skin_name",

As the ui_skin value is set in an array declaration, make sure you put a comma after the last double-quote - or you'll get an error when the file will be parsed. This setting, like most of them, is case-sensitive.


=== Event Filtering

You can define a filter so you only display what is really important to you and your staff. This filter is global, so if you need more filtering options, see the Contexts section below. This filter is defined in include/config.php.

A basic filter is defined by default :
	"ev_filt" =>    "status.prodState=1000 and status.severity>1 and status.eventstate!=2",
(Note this line MUST end with a comma, or ZiPEC will fail to load)
This filter will only show events related to device in Production state (1000), whose severity is above 'Debug' and state is not suppressed (!=2)

By default, the possible values are :
Production State : 
	Production	1000
	Pre-Production	500
	Test		400
	Maintenance	300
	Decommissioned	-1

Severity :
	Critical	5
	Error		4
	Warning		3
	Info		2
	Debug		1

State :
	New		0
	Acknowledged	1
	Suppressed	2

You can change this setting to your liking, and you can add other variables conditions you may need. See the available variables in the Contexts section. This filter applies to all contexts, so if you need more flexibility, you can set :
	"ev_filt" =>    "1",
Then define contexts on a per-user basis, with the suitable filters.


=== USING CONTEXTS

ZiPEC allows you to define various filters so your staff members can choose to only display what is relevant to them. This is configurable via SQL filters that can be inserted in the query.
To activate Contexts, make sure use_con is set to TRUE in include/config.php, and that you properly defined the various contexts you need in the contexts section of the config file.
A context is defined by three values stored in the $cfg['context'] array :
	$cfg['context']['MyContext'] : 		TRUE | FALSE : Enables or disables the context
	$cfg['context']['MyContext_label'] : 	Label string for the context
	$cfg['context']['MyContext_filter'] : 	SQL clause used as a filter

To use this context, you need to invoke ZiPEC with this URL : 
	http://YourZiPECServer/?context=MyContext
Note that the context name is case sensitive. You can then install multiple occurences of ZiPEC on a given iPhone, with different contexts

(Nota Bene: Since release 0.3, current context is displayed in the setup utility, however, it's a readonly parameter. Future versions may allow context selection from the interface)

The SQL filter can use any of the following fields :
+-------------------+----------------------+------+-----+-------------------+-------+
| Field             | Type                 | Null | Key | Default           | Extra |
+-------------------+----------------------+------+-----+-------------------+-------+
| dedupid           | varchar(255)         | NO   | PRI |                   |       |
| evid              | char(25)             | NO   | MUL |                   |       |
| device            | varchar(128)         | NO   | MUL |                   |       |
| component         | varchar(128)         | YES  |     |                   |       |
| eventClass        | varchar(128)         | YES  |     | /Unknown          |       |
| eventKey          | varchar(128)         | YES  |     |                   |       |
| summary           | varchar(128)         | NO   |     |                   |       |
| message           | varchar(4096)        | YES  |     |                   |       |
| severity          | smallint(6)          | YES  | MUL | -1                |       |
| eventState        | smallint(6)          | YES  |     | 0                 |       |
| eventClassKey     | varchar(128)         | YES  |     |                   |       |
| eventGroup        | varchar(64)          | YES  |     |                   |       |
| stateChange       | timestamp            | NO   |     | CURRENT_TIMESTAMP |       |
| firstTime         | double               | YES  |     | NULL              |       |
| lastTime          | double               | YES  |     | NULL              |       |
| count             | int(11)              | YES  |     | 1                 |       |
| prodState         | smallint(6)          | YES  |     | 0                 |       |
| suppid            | char(36)             | NO   |     |                   |       |
| manager           | varchar(128)         | NO   |     |                   |       |
| agent             | varchar(64)          | NO   |     |                   |       |
| DeviceClass       | varchar(128)         | YES  |     |                   |       |
| Location          | varchar(128)         | YES  |     |                   |       |
| Systems           | varchar(255)         | YES  |     |                   |       |
| DeviceGroups      | varchar(255)         | YES  |     |                   |       |
| ipAddress         | char(15)             | YES  |     |                   |       |
| facility          | varchar(8)           | YES  |     | unknown           |       |
| priority          | smallint(6)          | YES  |     | -1                |       |
| ntevid            | smallint(5) unsigned | YES  |     | 0                 |       |
| ownerid           | varchar(32)          | YES  |     |                   |       |
| clearid           | char(25)             | YES  | MUL | NULL              |       |
| DevicePriority    | smallint(6)          | YES  |     | 3                 |       |
| eventClassMapping | varchar(128)         | YES  |     |                   |       |
| monitor           | varchar(128)         | YES  |     |                   |       |
+-------------------+----------------------+------+-----+-------------------+-------+

Example :
You may want to display events only for the devices located in Houston,TX :
	$cfg['context']['houston'] = 		TRUE ;
	$cfg['context']['houston_label'] =	"Houston Office" ;
	$cfg['context']['houston_filter'] =	"Location like "%houston%";

Note that the Zenoss event database is case insensitive. Make sure each line ends with a semi-colon, or ZiPEC will fail to load.


=== SUPPORT / FEATURE REQUESTS
In case of trouble or if you need a specific feature, you can contact the author via SourceForge to get support. You can also visit the official Zenoss forum and get in touch with me there (my username is Weetos)


=== HELP WANTED !
Everyone's able to help me getting ZiPEC better is welcome. If you're a Python/AJAX coder who have a good knowledge of Zenoss API, and of course if you're interested in this project, feel free to contact me via SourceForge.

